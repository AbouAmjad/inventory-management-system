<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Inventory System (Supabase)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles applied to body and main container */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800 p-4;
        }
        .container {
            @apply max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 mt-8;
        }

        /* Styles for tab buttons (shared by auth and app tabs) */
        .tab-button {
            @apply px-5 py-3 rounded-t-lg text-base font-medium text-gray-600 border-b-2 border-transparent transition-colors duration-200 focus:outline-none;
        }
        .tab-button.active {
            @apply text-blue-700 border-blue-500 bg-gray-50;
        }

        /* Styles for tab content areas */
        .tab-content {
            @apply p-6 bg-white rounded-b-xl shadow-inner;
        }

        /* Form group spacing */
        .form-group {
            @apply mb-5;
        }

        /* Label styling */
        label {
            @apply block text-sm font-semibold text-gray-700 mb-1;
        }

        /* Input field styling (email, password, text, number, textarea) */
        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        textarea {
            @apply mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-base;
        }

        /* Button styling */
        button {
            @apply w-full inline-flex justify-center py-2.5 px-4 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 transform hover:scale-105;
        }
        button:disabled {
            @apply bg-gray-400 hover:bg-gray-400 cursor-not-allowed transform-none;
        }

        /* Message box styling (success/error) */
        .message-box {
            @apply mt-5 p-4 rounded-lg text-sm font-medium border;
        }
        .message-success {
            @apply bg-green-100 text-green-800 border-green-300;
        }
        .message-error {
            @apply bg-red-100 text-red-800 border-red-300;
        }

        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.75rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Autocomplete specific styles */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-list {
            position: absolute;
            border: 1px solid #e2e8f0; /* gray-200 */
            max-height: 180px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            border-radius: 0 0 0.5rem 0.5rem; /* rounded-b-lg */
            margin-top: 0.25rem; /* mt-1 */
        }
        .autocomplete-list-item {
            padding: 10px 16px;
            cursor: pointer;
            @apply text-gray-700 hover:bg-blue-50 transition-colors duration-150;
        }
        .autocomplete-list-item.selected {
            @apply bg-blue-100; /* For keyboard navigation */
        }

        /* Inventory Table specific styles */
        .inventory-table-container {
            @apply mt-8 bg-white p-6 rounded-xl shadow-lg;
        }
        .inventory-table {
            @apply min-w-full divide-y divide-gray-200;
        }
        .inventory-table th {
            @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .inventory-table td {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
        }
        .inventory-table tbody tr:nth-child(even) {
            @apply bg-gray-50;
        }
        .inventory-table-empty {
            @apply text-center py-8 text-gray-500;
        }

        /* User info bar for logged-in state */
        .user-info-bar {
            @apply flex justify-between items-center bg-gray-50 p-3 rounded-t-lg shadow-sm mb-4;
        }
        .user-info-bar button {
            @apply w-auto py-2 px-4 text-sm bg-red-600 hover:bg-red-700;
        }
        #loggedInUserEmail {
            @apply text-base font-semibold text-gray-700;
        }

        /* Transitions for showing/hiding auth/app screens */
        #authScreen, #appScreen {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
    <!-- Supabase Client SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center mb-6 text-blue-800">Online Inventory System</h1>

        <!-- Authentication Screen (visible when not logged in) -->
        <div id="authScreen" class="p-6 md:p-8">
            <div class="flex border-b border-gray-200 mb-6 bg-gray-50 rounded-t-lg shadow-sm">
                <button class="tab-button active" onclick="showAuthTab(event, 'signInForm')">Sign In</button>
                <button class="tab-button" onclick="showAuthTab(event, 'signUpForm')">Sign Up</button>
            </div>

            <!-- Sign In Form -->
            <div id="signInForm" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">Sign In</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" id="loginBtn">Sign In</button>
                    <div id="loginMessage" class="message-box hidden"></div>
                </form>
            </div>

            <!-- Sign Up Form -->
            <div id="signUpForm" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">Sign Up</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="your@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="••••••••" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirm Password</label>
                        <input type="password" id="registerConfirmPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" id="registerBtn">Sign Up</button>
                    <div id="registerMessage" class="message-box hidden"></div>
                </form>
            </div>
        </div>

        <!-- Main Application Screen (visible when logged in) -->
        <div id="appScreen" class="hidden">
            <div class="user-info-bar">
                <span id="loggedInUserEmail" class="text-base font-semibold text-gray-700"></span>
                <button id="logoutBtn" class="text-sm">Logout</button>
            </div>

            <div class="flex border-b border-gray-200 mb-6 bg-gray-50 rounded-t-lg shadow-sm">
                <button class="tab-button active" onclick="openAppTab(event, 'addItemTab')">Add New Item</button>
                <button class="tab-button" onclick="openAppTab(event, 'incomingTab')">Record Incoming</button>
                <button class="tab-button" onclick="openAppTab(event, 'outgoingTab')">Record Outgoing</button>
                <button class="tab-button" onclick="openAppTab(event, 'viewInventoryTab')">View Inventory</button>
            </div>

            <!-- Add Item Tab -->
            <div id="addItemTab" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">Add New Item</h2>
                <form id="addItemForm">
                    <div class="form-group">
                        <label for="itemId">Item ID (Unique)*</label>
                        <input type="text" id="itemId" name="item_id" placeholder="e.g., SKU-001" required>
                    </div>
                    <div class="form-group">
                        <label for="itemName">Item Name*</label>
                        <input type="text" id="itemName" name="item_name" placeholder="e.g., Wireless Mouse" required>
                    </div>
                    <div class="form-group">
                        <label for="itemDescription">Description</label>
                        <textarea id="itemDescription" name="description" rows="3" placeholder="e.g., Ergonomic wireless mouse with 2.4GHz connectivity"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="unitCost">Unit Cost*</label>
                        <input type="number" id="unitCost" name="unit_cost" step="0.01" min="0" placeholder="e.g., 15.50" required>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice">Selling Price*</label>
                        <input type="number" id="sellingPrice" name="selling_price" step="0.01" min="0" placeholder="e.g., 29.99" required>
                    </div>
                    <button type="submit" id="addItemBtn">Add Item</button>
                    <div id="addItemMessage" class="message-box hidden"></div>
                </form>
            </div>

            <!-- Record Incoming Tab -->
            <div id="incomingTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">Record Incoming Stock</h2>
                <form id="incomingForm">
                    <div class="form-group autocomplete-container">
                        <label for="incomingItemId">Item ID*</label>
                        <input type="text" id="incomingItemId" name="item_id" placeholder="Start typing item ID..." required onkeyup="filterItems(this, 'incomingAutocompleteList')" autocomplete="off">
                        <div id="incomingAutocompleteList" class="autocomplete-list hidden"></div>
                    </div>
                    <div class="form-group">
                        <label for="incomingQuantity">Quantity*</label>
                        <input type="number" id="incomingQuantity" name="quantity" min="1" placeholder="e.g., 50" required>
                    </div>
                    <div class="form-group">
                        <label for="incomingSupplier">Supplier</label>
                        <input type="text" id="incomingSupplier" name="supplier" placeholder="e.g., Tech Distributors Inc.">
                    </div>
                    <div class="form-group">
                        <label for="incomingDeliveryNote">Delivery Note Number</label>
                        <input type="text" id="incomingDeliveryNote" name="delivery_note" placeholder="e.g., DN-2025-001">
                    </div>
                    <div class="form-group">
                        <label for="incomingPoNumber">Purchase Order (PO) Number</label>
                        <input type="text" id="incomingPoNumber" name="po_number" placeholder="e.g., PO-ABC-456">
                    </div>
                    <div class="form-group">
                        <label for="incomingNotes">Notes</label>
                        <textarea id="incomingNotes" name="notes" rows="3" placeholder="e.g., First batch of 2025"></textarea>
                    </div>
                    <button type="submit" id="incomingBtn">Record Incoming</button>
                    <div id="incomingMessage" class="message-box hidden"></div>
                </form>
            </div>

            <!-- Record Outgoing Tab -->
            <div id="outgoingTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">Record Outgoing Stock</h2>
                <form id="outgoingForm">
                    <div class="form-group autocomplete-container">
                        <label for="outgoingItemId">Item ID*</label>
                        <input type="text" id="outgoingItemId" name="item_id" placeholder="Start typing item ID..." required onkeyup="filterItems(this, 'outgoingAutocompleteList')" autocomplete="off">
                        <div id="outgoingAutocompleteList" class="autocomplete-list hidden"></div>
                    </div>
                    <div class="form-group">
                        <label for="outgoingQuantity">Quantity*</label>
                        <input type="number" id="outgoingQuantity" name="quantity" min="1" placeholder="e.g., 10" required>
                    </div>
                    <div class="form-group">
                        <label for="outgoingCustomer">Customer</label>
                        <input type="text" id="outgoingCustomer" name="customer" placeholder="e.g., John Doe / ABC Corp.">
                    </div>
                    <div class="form-group">
                        <label for="outgoingNotes">Notes</label>
                        <textarea id="outgoingNotes" name="notes" rows="3" placeholder="e.g., Sold via online store"></textarea>
                    </div>
                    <button type="submit" id="outgoingBtn">Record Outgoing</button>
                    <div id="outgoingMessage" class="message-box hidden"></div>
                </form>
            </div>

            <!-- View Inventory Tab -->
            <div id="viewInventoryTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">Current Inventory</h2>
                <div class="form-group">
                    <label for="inventorySearch">Search Item (ID or Name)</label>
                    <input type="text" id="inventorySearch" placeholder="Search by Item ID or Item Name..." onkeyup="filterInventoryTable()">
                </div>
                <div class="inventory-table-container">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Item ID</th>
                                <th>Item Name</th>
                                <th>Description</th>
                                <th>Unit Cost</th>
                                <th>Selling Price</th>
                                <th>Current Stock</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Inventory items will be rendered here by JavaScript -->
                        </tbody>
                    </table>
                    <p id="inventoryEmptyState" class="inventory-table-empty">No items in inventory. Add a new item to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // YOUR SUPABASE PROJECT URL AND ANON KEY
        const SUPABASE_URL = 'https://vjhikffducpurixlkfjd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqaGlrZmZkdWNwdXJpeGxrZmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNzIxNTcsImV4cCI6MjA2Njc0ODE1N30.lLlq3LYmHqpG7c5WOgfNFscRLjPDKkWnTkllw_X4Q_Y';

        let supabase;
        let userId = null; // Will be set after successful login
        window.allItems = []; // Global array for autocomplete items
        let currentInventoryData = []; // Store the full inventory data for client-side filtering

        // --- Authentication & Initialization ---

        async function initializeSupabase() {
            // Basic check for placeholder values
            if (SUPABASE_URL.includes('YOUR_SUPABASE_URL') || SUPABASE_ANON_KEY.includes('YOUR_SUPABASE_ANON_KEY')) {
                document.getElementById('loggedInUserEmail').textContent = 'ERROR: Please set Supabase URL/Key!';
                return;
            }

            // Create Supabase client
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Listen for authentication state changes
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth event:', event, 'Session:', session);
                if (session) {
                    userId = session.user.id;
                    document.getElementById('loggedInUserEmail').textContent = `Logged in as: ${session.user.email}`;
                    showAppScreen();
                    setupRealtimeInventoryListener(); // Set up listener AFTER user is logged in
                } else {
                    userId = null;
                    showAuthScreen();
                    // Clear inventory data if logged out
                    currentInventoryData = [];
                    window.allItems = [];
                    renderInventoryTable([]);
                }
            });

            // Check initial session status on page load
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error("Error getting initial session:", error.message);
                showAuthScreen(); // If error, default to auth screen
            } else if (session) {
                // If session exists, onAuthStateChange will handle setting userId and showing app screen
                // No explicit action needed here, onAuthStateChange will fire
            } else {
                // No active session, show auth screen
                showAuthScreen();
            }

            // Initially display sign-in tab
            document.querySelector('#authScreen .tab-button').click();
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        function showAppScreen() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            // When app screen is shown, default to Add Item tab
            document.querySelector('#appScreen .tab-button').click();
        }

        // --- Supabase Data Interactions (Identical to previous, but now relies on `userId` from auth) ---

        /**
         * Sets up a real-time listener for the 'products' table in Supabase.
         * This updates the inventory table whenever data changes for the current user.
         */
        function setupRealtimeInventoryListener() {
            if (!supabase || !userId) { // userId must be available for this
                console.warn("Supabase client or user ID not ready for inventory listener. Skipping listener setup.");
                return;
            }

            // Ensure previous subscriptions are removed before creating new ones for a new user
            supabase.removeAllChannels(); // Disconnects all existing subscriptions

            // Subscribe to changes *for the current user's data only*
            supabase
                .channel('public:products') // Use a specific channel name for the table
                .on('postgres_changes', { event: '*', schema: 'public', table: 'products', filter: `user_id=eq.${userId}` }, payload => {
                    console.log('Change received!', payload);
                    fetchInventoryAndRender(); // Re-fetch all and re-render on any change to product table
                })
                .subscribe(); // Subscribe to real-time changes

            fetchInventoryAndRender(); // Initial fetch and render for the logged-in user
        }

        /**
         * Fetches inventory data from Supabase and renders it into the table.
         */
        async function fetchInventoryAndRender() {
            if (!supabase || !userId) { // userId must be available for this
                console.warn("Supabase client or user ID not ready to fetch inventory.");
                return;
            }

            // Fetch only items belonging to the current user
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .eq('user_id', userId) // Filter by current user's ID
                .order('item_name', { ascending: true }); // Order by item name

            if (error) {
                console.error('Error fetching inventory:', error.message);
                document.getElementById('inventoryEmptyState').textContent = `Error loading inventory: ${error.message}`;
                document.getElementById('inventoryEmptyState').classList.remove('hidden');
            } else {
                currentInventoryData = data; // Store full data for filtering
                window.allItems = data.map(item => ({ id: item.item_id, name: item.item_name })); // Update global autocomplete list
                filterInventoryTable(); // Render/filter the table with the new data
                console.log("Inventory data fetched and rendered.");
            }
        }

        /**
         * Renders the inventory data into the HTML table.
         * @param {Array<Object>} items - An array of inventory item objects.
         */
        function renderInventoryTable(items) {
            const tableBody = document.getElementById('inventoryTableBody');
            const emptyState = document.getElementById('inventoryEmptyState');
            tableBody.innerHTML = ''; // Clear existing rows

            if (items.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.textContent = 'No items in inventory. Add a new item to get started!';
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            items.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.item_id || 'N/A';
                row.insertCell().textContent = item.item_name || 'N/A';
                row.insertCell().textContent = item.description || '';
                row.insertCell().textContent = `$${(parseFloat(item.unit_cost) || 0).toFixed(2)}`;
                row.insertCell().textContent = `$${(parseFloat(item.selling_price) || 0).toFixed(2)}`;
                row.insertCell().textContent = item.current_stock !== undefined ? item.current_stock : 'N/A';
            });
        }

        /**
         * Filters the currently displayed inventory table based on search input.
         * This function uses the `currentInventoryData` to filter client-side.
         */
        function filterInventoryTable() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const filteredItems = currentInventoryData.filter(item =>
                item.item_id.toLowerCase().includes(searchTerm) ||
                item.item_name.toLowerCase().includes(searchTerm) ||
                (item.description && item.description.toLowerCase().includes(searchTerm)) // Check description only if it exists
            );
            renderInventoryTable(filteredItems);
        }


        // --- UI Helper Functions (adapted for auth tabs vs app tabs) ---

        /**
         * Function to switch between authentication tabs (Sign In / Sign Up).
         * @param {Event} evt - The click event.
         * @param {string} tabName - The ID of the tab content to show.
         */
        function showAuthTab(evt, tabName) {
            let i, tabcontent, tabbuttons;

            tabcontent = document.querySelectorAll("#authScreen .tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tabbuttons = document.querySelectorAll("#authScreen .tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        /**
         * Function to switch between main app tabs.
         * @param {Event} evt - The click event.
         * @param {string} tabName - The ID of the tab content to show.
         */
        function openAppTab(evt, tabName) {
            let i, tabcontent, tabbuttons;

            tabcontent = document.querySelectorAll("#appScreen .tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tabbuttons = document.querySelectorAll("#appScreen .tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }


        /**
         * Shows a message in a designated message box.
         * @param {string} messageBoxId - The ID of the div element to display the message in.
         * @param {string} message - The text message to display.
         * @param {boolean} isSuccess - True for success message (green), false for error (red).
         */
        function showMessage(messageBoxId, message, isSuccess) {
            const messageBox = document.getElementById(messageBoxId);
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'message-success', 'message-error');
            if (isSuccess) {
                messageBox.classList.add('message-success');
            } else {
                messageBox.classList.add('message-error');
            }
        }

        /**
         * Hides a message box.
         * @param {string} messageBoxId - The ID of the div element to hide.
         */
        function hideMessage(messageBoxId) {
            document.getElementById(messageBoxId).classList.add('hidden');
        }

        /**
         * Disables a button and shows a loading spinner.
         * @param {string} buttonId - The ID of the button to disable.
         */
        function showLoading(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.innerHTML = 'Processing... <span class="loading-spinner"></span>';
        }

        /**
         * Enables a button and restores its original text.
         * @param {string} buttonId - The ID of the button to enable.
         * @param {string} originalText - The original text of the button.
         */
        function hideLoading(buttonId, originalText) {
            const button = document.getElementById(buttonId);
            button.disabled = false;
            button.textContent = originalText;
        }

        // --- Authentication Forms Submission ---

        // Register Form
        document.getElementById('registerForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessage('registerMessage');
            showLoading('registerBtn');

            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('registerMessage', 'Passwords do not match.', false);
                hideLoading('registerBtn', 'Sign Up');
                return;
            }

            // Supabase sign up
            const { error } = await supabase.auth.signUp({ email, password });

            hideLoading('registerBtn', 'Sign Up');
            if (error) {
                console.error('Sign up error:', error.message);
                showMessage('registerMessage', `Sign up error: ${error.message}`, false);
            } else {
                showMessage('registerMessage', 'Sign up successful! Please sign in.', true);
                this.reset();
                // Optionally switch to login tab after successful registration
                document.querySelector('#authScreen #signInForm').style.display = "block"; // Show Sign In form
                document.querySelector('#authScreen #signUpForm').style.display = "none"; // Hide Sign Up form
                // Update active tab button visuals
                document.querySelector('#authScreen .tab-button:nth-child(2)').classList.remove("active"); // Deactivate Sign Up button
                document.querySelector('#authScreen .tab-button:nth-child(1)').classList.add("active"); // Activate Sign In button
            }
        });

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessage('loginMessage');
            showLoading('loginBtn');

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Supabase sign in
            const { error } = await supabase.auth.signInWithPassword({ email, password });

            hideLoading('loginBtn', 'Sign In');
            if (error) {
                console.error('Login error:', error.message);
                showMessage('loginMessage', `Login error: ${error.message}`, false);
            } else {
                showMessage('loginMessage', 'Logged in successfully!', true);
                this.reset();
                // onAuthStateChange will handle showing the app screen
            }
        });

        // Logout Button
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            showLoading('logoutBtn');
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error.message);
                showMessage('loggedInUserEmail', `Logout failed: ${error.message}`, false); // Show error in user info bar
            } else {
                console.log('Logged out successfully');
                // onAuthStateChange will handle showing the auth screen
            }
            hideLoading('logoutBtn', 'Logout');
        });


        // --- App Forms Submission (Add, Incoming, Outgoing) ---

        // Add Item Form
        document.getElementById('addItemForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessage('addItemMessage');
            showLoading('addItemBtn');

            if (!supabase || !userId) {
                showMessage('addItemMessage', 'Authentication required to add items.', false);
                hideLoading('addItemBtn', 'Add Item');
                return;
            }

            const formData = new FormData(this);
            const itemData = { user_id: userId, current_stock: 0 };
            for (const [key, value] of formData.entries()) {
                itemData[key] = value.trim();
            }
            itemData.unit_cost = parseFloat(itemData.unit_cost) || 0;
            itemData.selling_price = parseFloat(itemData.selling_price) || 0;

            const { data: existingItems, error: fetchError } = await supabase
                .from('products')
                .select('item_id')
                .eq('user_id', userId)
                .eq('item_id', itemData.item_id);

            if (fetchError) {
                showMessage('addItemMessage', `Error checking item ID: ${fetchError.message}`, false);
                hideLoading('addItemBtn', 'Add Item');
                return;
            }

            if (existingItems && existingItems.length > 0) {
                showMessage('addItemMessage', `Error: Item with ID '${itemData.item_id}' already exists for your inventory.`, false);
                hideLoading('addItemBtn', 'Add Item');
                return;
            }

            const { error } = await supabase
                .from('products')
                .insert([itemData]);

            if (error) {
                console.error("Error adding item:", error);
                showMessage('addItemMessage', `Error adding item: ${error.message}`, false);
            } else {
                showMessage('addItemMessage', `Item '${itemData.item_name}' added successfully!`, true);
                this.reset();
            }
            hideLoading('addItemBtn', 'Add Item');
        });

        // Incoming Form
        document.getElementById('incomingForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessage('incomingMessage');
            showLoading('incomingBtn');

            if (!supabase || !userId) {
                showMessage('incomingMessage', 'Authentication required to record incoming stock.', false);
                hideLoading('incomingBtn', 'Record Incoming');
                return;
            }

            const formData = new FormData(this);
            const transactionData = { user_id: userId };
            for (const [key, value] of formData.entries()) {
                transactionData[key] = value.trim();
            }
            transactionData.quantity = parseInt(transactionData.quantity) || 0;

            if (isNaN(transactionData.quantity) || transactionData.quantity <= 0) {
                showMessage('incomingMessage', "Quantity must be a positive number.", false);
                hideLoading('incomingBtn', 'Record Incoming');
                return;
            }

            const { data: products, error: fetchProductError } = await supabase
                .from('products')
                .select('id, current_stock')
                .eq('user_id', userId)
                .eq('item_id', transactionData.item_id);

            if (fetchProductError) {
                showMessage('incomingMessage', `Error finding item: ${fetchProductError.message}`, false);
                hideLoading('incomingBtn', 'Record Incoming');
                return;
            }
            if (!products || products.length === 0) {
                showMessage('incomingMessage', `Error: Item ID '${transactionData.item_id}' not found in your inventory.`, false);
                hideLoading('incomingBtn', 'Record Incoming');
                return;
            }

            const product = products[0];
            const newStock = (product.current_stock || 0) + transactionData.quantity;

            const { error: insertError } = await supabase
                .from('incoming_transactions')
                .insert([transactionData]);

            if (insertError) {
                console.error("Error recording incoming transaction:", insertError);
                showMessage('incomingMessage', `Error recording incoming: ${insertError.message}`, false);
                hideLoading('incomingBtn', 'Record Incoming');
                return;
            }

            const { error: updateError } = await supabase
                .from('products')
                .update({ current_stock: newStock })
                .eq('id', product.id)
                .eq('user_id', userId);

            if (updateError) {
                console.error("Error updating stock:", updateError);
                showMessage('incomingMessage', `Error updating stock: ${updateError.message}`, false);
            } else {
                showMessage('incomingMessage', `Incoming stock for '${transactionData.item_id}' recorded successfully!`, true);
                this.reset();
                document.getElementById('incomingAutocompleteList').innerHTML = '';
                document.getElementById('incomingAutocompleteList').classList.add('hidden');
            }
            hideLoading('incomingBtn', 'Record Incoming');
        });

        // Outgoing Form
        document.getElementById('outgoingForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessage('outgoingMessage');
            showLoading('outgoingBtn');

            if (!supabase || !userId) {
                showMessage('outgoingMessage', 'Authentication required to record outgoing stock.', false);
                hideLoading('outgoingBtn', 'Record Outgoing');
                return;
            }

            const formData = new FormData(this);
            const transactionData = { user_id: userId };
            for (const [key, value] of formData.entries()) {
                transactionData[key] = value.trim();
            }
            transactionData.quantity = parseInt(transactionData.quantity) || 0;

            if (isNaN(transactionData.quantity) || transactionData.quantity <= 0) {
                showMessage('outgoingMessage', "Quantity must be a positive number.", false);
                hideLoading('outgoingBtn', 'Record Outgoing');
                return;
            }

            const { data: products, error: fetchProductError } = await supabase
                .from('products')
                .select('id, current_stock')
                .eq('user_id', userId)
                .eq('item_id', transactionData.item_id);

            if (fetchProductError) {
                showMessage('outgoingMessage', `Error finding item: ${fetchProductError.message}`, false);
                hideLoading('outgoingBtn', 'Record Outgoing');
                return;
            }
            if (!products || products.length === 0) {
                showMessage('outgoingMessage', `Error: Item ID '${transactionData.item_id}' not found in your inventory.`, false);
                hideLoading('outgoingBtn', 'Record Outgoing');
                return;
            }

            const product = products[0];
            const currentStock = product.current_stock || 0;

            if (currentStock < transactionData.quantity) {
                showMessage('outgoingMessage', `Error: Insufficient stock for '${transactionData.item_id}'. Current stock: ${currentStock}, Requested: ${transactionData.quantity}.`, false);
                hideLoading('outgoingBtn', 'Record Outgoing');
                return;
            }

            const newStock = currentStock - transactionData.quantity;

            const { error: insertError } = await supabase
                .from('outgoing_transactions')
                .insert([transactionData]);

            if (insertError) {
                console.error("Error recording outgoing transaction:", insertError);
                showMessage('outgoingMessage', `Error recording outgoing: ${insertError.message}`, false);
                hideLoading('outgoingBtn', 'Record Outgoing');
                return;
            }

            const { error: updateError } = await supabase
                .from('products')
                .update({ current_stock: newStock })
                .eq('id', product.id)
                .eq('user_id', userId);

            if (updateError) {
                console.error("Error updating stock:", updateError);
                showMessage('outgoingMessage', `Error updating stock: ${updateError.message}`, false);
            } else {
                showMessage('outgoingMessage', `Outgoing stock for '${transactionData.item_id}' recorded successfully!`, true);
                this.reset();
                document.getElementById('outgoingAutocompleteList').innerHTML = '';
                document.getElementById('outgoingAutocompleteList').classList.add('hidden');
            }
            hideLoading('outgoingBtn', 'Record Outgoing');
        });

        // --- Autocomplete Logic (Remains largely the same) ---

        let currentFocus = -1;

        /**
         * Filters items based on user input for autocomplete.
         * @param {HTMLInputElement} inputElement - The input field where user is typing.
         * @param {string} listId - The ID of the autocomplete list div.
         */
        function filterItems(inputElement, listId) {
            const inputValue = inputElement.value.toLowerCase();
            const autocompleteList = document.getElementById(listId);
            autocompleteList.innerHTML = '';
            autocompleteList.classList.remove('hidden');
            currentFocus = -1;

            if (!inputValue) {
                autocompleteList.classList.add('hidden');
                return;
            }

            const filteredItems = window.allItems.filter(item =>
                item.id.toLowerCase().includes(inputValue) ||
                item.name.toLowerCase().includes(inputValue)
            );

            if (filteredItems.length === 0) {
                autocompleteList.classList.add('hidden');
                return;
            }

            filteredItems.slice(0, 10).forEach((item, index) => {
                const div = document.createElement('div');
                div.classList.add('autocomplete-list-item');
                div.innerHTML = `${highlightMatch(item.id, inputValue)} - ${highlightMatch(item.name, inputValue)}`;
                div.dataset.itemId = item.id;
                div.addEventListener('click', function() {
                    inputElement.value = this.dataset.itemId;
                    autocompleteList.classList.add('hidden');
                    inputElement.focus();
                });
                autocompleteList.appendChild(div);
            });
        }

        /**
         * Highlights the matching part of the string.
         * @param {string} text - The full text.
         * @param {string} match - The string to match.
         * @returns {string} HTML string with highlights.
         */
        function highlightMatch(text, match) {
            const index = text.toLowerCase().indexOf(match);
            if (index > -1) {
                return text.substring(0, index) +
                       '<strong>' + text.substring(index, index + match.length) + '</strong>' +
                       text.substring(index + match.length);
            }
            return text;
        }

        // Keyboard navigation for autocomplete
        document.addEventListener('keydown', function(e) {
            let autocompleteList;
            let inputElement;

            if (document.getElementById('incomingTab').style.display !== 'none') {
                autocompleteList = document.getElementById('incomingAutocompleteList');
                inputElement = document.getElementById('incomingItemId');
            } else if (document.getElementById('outgoingTab').style.display !== 'none') {
                autocompleteList = document.getElementById('outgoingAutocompleteList');
                inputElement = document.getElementById('outgoingItemId');
            } else {
                return;
            }

            if (autocompleteList.classList.contains('hidden')) return;

            const items = autocompleteList.querySelectorAll('.autocomplete-list-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentFocus = (currentFocus + 1) % items.length;
                setActiveItem(items, currentFocus);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentFocus = (currentFocus - 1 + items.length) % items.length;
                setActiveItem(items, currentFocus);
            } else if (e.key === 'Enter') {
                if (currentFocus > -1) {
                    e.preventDefault();
                    items[currentFocus].click();
                }
            }
        });

        /**
         * Sets the active (highlighted) item in the autocomplete list.
         * @param {NodeList} items - All autocomplete list items.
         * @param {number} index - The index of the item to make active.
         */
        function setActiveItem(items, index) {
            items.forEach((item, i) => {
                item.classList.remove('selected');
            });
            if (index > -1 && index < items.length) {
                items[index].classList.add('selected');
                items[index].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }


        // Hide autocomplete list when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.autocomplete-container')) {
                document.getElementById('incomingAutocompleteList').classList.add('hidden');
                document.getElementById('outgoingAutocompleteList').classList.add('hidden');
            }
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeSupabase();
        });
    </script>
</body>
</html>
